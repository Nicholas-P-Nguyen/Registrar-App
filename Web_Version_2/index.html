<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Registrar's Office Class Search</title>
    </head>
    <body>
        <h1>Registrar's Office: Class Search</h1>

        <!-- Search form -->
        <div class="row">
            <div class="col-sm-3">
               <input class="form-control" type="text"
                  placeholder="Department"
                  name="dept" id="deptInput" autoFocus>
            </div>
            <div class="col-sm-3">
               <input class="form-control" type="text"
                  placeholder="Number"
                  name="coursenum" id="coursenumInput">
            </div>
            <div class="col-sm-3">
               <input class="form-control" type="text"
                  placeholder="Area"
                  name="area" id="areaInput">
            </div>
            <div class="col-sm-3">
               <input class="form-control" type="text"
                  placeholder="Title"
                  name="title" id="titleInput">
            </div>
         </div>

        <hr>
        <!-- Search results -->
        <div id="resultOverviews"></div>
        <br>


        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Importing mustache, template engine for JS -->
        <script src="https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.min.js"></script>
        <!-- JavaScript Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- CSS Bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">


        <script>
            'use strict';

            function handleResponse(overviews) {
                console.log(overviews)


                let success = overviews[0]

                if (success) {
                    let html = convertOverviewsToHtml(overviews[1])
                    $('#resultOverviews').html(html)
                }
            }

            function convertOverviewsToHtml(overviews) {
                let template = ` 
                <table class="results" id="overviewsTable">
                    <thead>
                        <tr>
                            <td><strong>ClassId</strong></td>
                            <td><strong>Dept</strong></td>
                            <td><strong>Num</strong></td>
                            <td><strong>Area</strong></td>
                            <td><strong>Title</strong></td>
                        </tr>
                    </thead>
                    <tbody>
                        {% raw %}
                        {{#overviews}}
                        <tr>
                            <td>{{classid}}</td>
                            <td>{{dept}}</td>
                            <td>{{coursenum}}</td>
                            <td>{{area}}</td>
                            <td>{{title}}</td>
                        </tr>
                        {{/overviews}}
                        {% endraw %}
                    </tbody>
                </table>
                `;
                let map = {overviews: overviews};
                let html = Mustache.render(template, map);
                return html
            }

            function handleError(request) {
                if (request.statusText !== 'abort') {
                    alert('Error: Failed to fetch data from server')
                }

            }

            let request = null;
            function getOverviews() {
                let dept = $('#deptInput').val();
                let encodedDept = encodeURIComponent(dept);

                let coursenum = $('#coursenumInput').val();
                let encodedCoursenum = encodeURIComponent(coursenum);

                let area = $('#areaInput').val();
                let encodedArea = encodeURIComponent(area);

                let title = $('#titleInput').val();
                let encodedTitle = encodeURIComponent(title);

                let url = '/regoverviews?dept=' + encodedDept + '&coursenum=' + encodedCoursenum + '&area=' + encodedArea + '&title=' + encodedTitle

                if (request !== null) {
                    request.abort();
                }
                let requestData = {
                    type: 'GET',
                    url: url,
                    success: handleResponse,
                    error: handleError
                };
                request = $.ajax(requestData)
            }

            let timer = null;
            function debouncedResults() {
                clearTimeout(timer);
                timer = window.setTimeout(getOverviews, 500)
            }

            function setup() {
                $('#deptInput').on('input', debouncedResults);
                $('#coursenumInput').on('input', debouncedResults);
                $('#areaInput').on('input', debouncedResults);
                $('#titleInput').on('input', debouncedResults);
                
                getOverviews();

            }
            $('document').ready(setup);
        </script>
    </body>
</html>